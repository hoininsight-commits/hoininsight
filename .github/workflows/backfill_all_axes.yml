name: Backfill All Axes

on:
  workflow_dispatch:
    inputs:
      date:
        description: 'Target Date (YYYY-MM-DD)'
        required: true
        default: '2026-01-14'

permissions:
  contents: write

jobs:
  backfill:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi

      - name: Run Pipeline (All Axes)
        env:
          HOIN_TARGET_DATE: ${{ inputs.date }}
        run: |
          # Only-axis BACKFILL maps to 'None' (All Categories) in run_pipeline.py
          python -m src.pipeline.run_pipeline --only-axis BACKFILL --target-date ${{ inputs.date }}

      - name: Verify Backfill Status
        run: |
          python3 - <<EOF
          import json
          from pathlib import Path
          
          target_date = '${{ inputs.date }}'
          print(f'[VERIFY][OK] Backfill completed for target_date={target_date}')
          
          try:
              status_path = Path('data/dashboard/collection_status.json')
              if not status_path.exists():
                  print(f'[VERIFY][FAIL] status file missing: {status_path}')
              else:
                  with open(status_path, 'r') as f:
                      status_data = json.load(f)
                  
                  # Count statuses
                  stats = {'OK': 0, 'SKIP': 0, 'FAIL': 0, 'WARN': 0}
                  total = 0
                  
                  for k, v in status_data.items():
                      s = v.get('status', 'FAIL')
                      if s in stats: stats[s] += 1
                      total += 1
                      
                  print(f"[VERIFY][INFO] datasets_total={total} ok={stats['OK']} skip={stats['SKIP']} fail={stats['FAIL']}")
          
          except Exception as e:
              print(f'[VERIFY][WARN] Failed to verify status: {e}')
          EOF

      - name: Commit outputs
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add data docs dashboard
          git commit -m "chore: initial backfill for ${{ inputs.date }} [skip ci]" || echo "No changes to commit"
          git pull --rebase
          git push
