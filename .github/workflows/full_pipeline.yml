name: full_pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    - cron: "0 23 * * *"

permissions:
  contents: write
  issues: write

env:
  ENABLE_LEARNING: false
  TZ: Asia/Seoul

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
                            
          
      - name: Production Sanity Check (IS-54)
        run: |
          python -m src.ops.production_sanity_check

      - name: Run Unit Tests (IS-57 to IS-62)
        run: |
          echo "[PIPELINE] Running Verification Tests..."
          python -m tests.verify_is57_capital_rotation
          python -m tests.verify_is59_corporate_action
          python -m tests.verify_is60_bottleneck_rank
          python -m tests.verify_is61_why_now
          python -m tests.verify_is62_script_lock
          echo "[PIPELINE] All Verification Tests Passed."

      - name: Set AS_OF_DATE
        run: |
          echo "AS_OF_DATE=$(TZ='Asia/Seoul' date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Run Data Collection
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          ECOS_API_KEY: ${{ secrets.ECOS_API_KEY }}
          COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
        run: |
          python -m src.collectors.market_collectors || echo "[WARN] Market collectors failed"
          python -m src.collectors.fred_collector || echo "[WARN] FRED collector failed"
          python -m src.collectors.ecos_collector || echo "[WARN] ECOS collector failed"
          python -m src.collectors.coingecko_collector || echo "[WARN] CoinGecko collector failed"
          python -m src.collectors.policy_collector || echo "[WARN] Policy collector failed"
          echo "[PIPELINE] Data collection completed"

      - name: Run Content Topic Gate
        run: |
          python -m src.pipeline.run_topic_gate --as-of-date "${AS_OF_DATE}"

      - name: Run engine
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          ECOS_API_KEY: ${{ secrets.ECOS_API_KEY }}
        run: |
          python -m src.engine


      - name: Notify Telegram (Daily Summary)
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python -m src.reporting.telegram_daily_summary

      - name: Upload Daily Brief Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: daily-reports
          path: data/reports/

      - name: Verify Phase 25 Meta Regime
        run: |
          YMD=$(TZ='Asia/Seoul' date +"%Y/%m/%d")
          REPORT="data/reports/$YMD/daily_brief.md"
          META="data/meta_topics/$YMD/meta_topics.json"

          echo "[VERIFY] Phase 25 Meta Regime Check"

          if [ ! -f "$REPORT" ]; then
            echo "[VERIFY][FAIL] daily_brief.md not found"
            exit 1
          fi

          if [ -f "$META" ] && [ "$(jq length $META)" -gt 0 ]; then
            if grep -q "Regime:" "$REPORT"; then
              echo "[VERIFY][OK] Regime Summary exists"
              echo "[VERIFY][OK] Meta Topic detected and used as Regime basis"
              echo "----- REGIME SUMMARY -----"
              sed -n '/## REGIME SUMMARY/,/## /p' "$REPORT" || true
              echo "--------------------------"
            else
              echo "[VERIFY][FAIL] Regime Summary missing despite meta topics existing"
              exit 1
            fi
          else
            echo "[VERIFY][SKIP] No meta topics detected today (valid state)"
          fi

      - name: Verify Phase 26 Regime History
        run: |
          YMD=$(TZ='Asia/Seoul' date +"%Y-%m-%d")
          SNAPSHOT="data/regimes/regime_$YMD.json"
          HISTORY="data/regimes/regime_history.json"

          echo "[VERIFY] Phase 26 Regime History Check"

          if [ ! -f "$SNAPSHOT" ]; then
            echo "[WARN] Regime history update skipped (missing daily regime file)"
            exit 0
          fi

          if [ ! -f "$HISTORY" ]; then
            echo "[VERIFY][FAIL] regime_history.json not found"
            exit 1
          fi

          echo "[VERIFY][OK] Regime history updated"

      - name: Verify Phase 27 Regime Strategy Mapping
        run: |
          MAP="registry/regime_strategy_map.yml"

          echo "[VERIFY] Phase 27 Regime-Strategy Mapping Check"

          if [ ! -f "$MAP" ]; then
            echo "[VERIFY][FAIL] regime_strategy_map.yml not found"
            exit 1
          fi

          echo "[VERIFY][OK] Regime-Strategy mapping file exists"

      - name: Verify Phase 28 Regime Retrospective
        run: |
          REVIEW="data/regime_reviews/regime_retrospective_v1.json"

          echo "[VERIFY] Phase 28 Regime Retrospective Check"

          if [ ! -f "$REVIEW" ]; then
            echo "[VERIFY][FAIL] regime_retrospective_v1.json not found"
            exit 1
          fi

          echo "[VERIFY][OK] Regime retrospective summary exists"

      - name: Verify Phase 29 Narrative Drift
        run: |
          DRIFT="data/narratives/narrative_drift_v1.json"

          echo "[VERIFY] Phase 29 Narrative Drift Check"

          if [ ! -f "$DRIFT" ]; then
            echo "[VERIFY][FAIL] narrative_drift_v1.json not found"
            exit 1
          fi

          echo "[VERIFY][OK] Narrative drift signals generated"

      - name: Verify Phase 30 Insight Content
        run: |
          SCRIPT="data/content/insight_script_v1.md"
          SHOTLIST="data/content/insight_shotlist_v1.md"

          echo "[VERIFY] Phase 30 Insight Content Check"

          if [ ! -f "$SCRIPT" ]; then
            echo "[VERIFY][FAIL] insight_script_v1.md not found"
            exit 1
          fi

          if [ ! -f "$SHOTLIST" ]; then
            echo "[VERIFY][FAIL] insight_shotlist_v1.md not found"
            exit 1
          fi

          echo "[VERIFY][OK] Insight script and shotlist generated"

      - name: Verify Confidence-Based Content Control
        run: |
          echo "[VERIFY] Confidence-Based Content Control Check"

          YMD=$(TZ='Asia/Seoul' date +"%Y/%m/%d")
          # Python script outputs to data/content/ directly (not date-partitioned)
          CONTENT_DIR="data/content" 
          REPORT="data/reports/$YMD/daily_brief.md"

          if grep -q "Confidence: LOW" "$REPORT"; then
            if [ -f "$CONTENT_DIR/content_skipped.md" ]; then
              echo "[VERIFY][OK] Content correctly skipped for LOW confidence"
            else
              # It's possible content generation hasn't run yet if we check too early? 
              # No, this step is after engine run.
              echo "[VERIFY][FAIL] Content not skipped despite LOW confidence"
              exit 1
            fi
          elif grep -q "Confidence: MEDIUM" "$REPORT"; then
             # Check for warning in script?
             if grep -q "Cautious Mode" "$CONTENT_DIR/insight_script_v1.md"; then
                echo "[VERIFY][OK] Cautious mode warning detected"
             else
                echo "[VERIFY][WARN] Cautious mode warning missing (logic check needed)"
                # Don't fail for now, maybe explicit check later
             fi
             echo "[VERIFY][OK] Content generation allowed (CAUTIOUS)"
          else
            echo "[VERIFY][OK] Content generation allowed (NORMAL)"
          fi

      - name: Verify Content Preset Selection
        run: |
          echo "[VERIFY] Content Preset Selection Check"

          YMD=$(TZ='Asia/Seoul' date +"%Y/%m/%d")
          REPORT="data/reports/$YMD/daily_brief.md"

          if [ ! -f "$REPORT" ]; then
            echo "[VERIFY][FAIL] daily_brief.md not found"
            exit 1
          fi

          if grep -q "^Content Preset:" "$REPORT"; then
            echo "[VERIFY][OK] Content preset emitted in report"
          # Optional: handle SKIP case where preset might not be emitted?
          # Ops v1.2 rule says "SKIP Ïãú ÌîÑÎ¶¨ÏÖã ÏÑ†ÌÉùÌïòÏßÄ ÏïäÏùå". 
          # My daily_report logic only appends line if != SKIP.
          # So I should check: if Content Status != SKIP, then Preset must exist.
          elif grep -q "Content Status: SKIP" "$REPORT"; then
            echo "[VERIFY][OK] Content skipped, no preset required"
          else
            echo "[VERIFY][FAIL] Content preset line missing (and not skipped)"
            exit 1
          fi

      - name: Verify Auto Collection Expansion
        run: |
          echo "[VERIFY] Auto Collection Expansion Check"

          if [ ! -f "registry/datasets.yml" ]; then
            echo "[VERIFY][FAIL] registry/datasets.yml not found"
            exit 1
          fi

          # Check new axes
          if grep -q "PRECIOUS_METALS" registry/datasets.yml && grep -q "CRYPTO" registry/datasets.yml; then
            echo "[VERIFY][OK] New dataset axes registered"
          else
            echo "[VERIFY][FAIL] New dataset axes not found in registry"
            exit 1
          fi

          echo "[VERIFY][INFO] Collector may skip if env vars missing (valid state)"

      - name: Verify Core Dataset and Regime Confidence
        run: |
          echo "[VERIFY] Core Dataset + Regime Confidence Check"

          # daily_briefÏóê Confidence ÎùºÏù∏Ïù¥ Ï°¥Ïû¨Ìï¥Ïïº Ìï®
          YMD=$(TZ='Asia/Seoul' date +"%Y/%m/%d")
          REPORT="data/reports/$YMD/daily_brief.md"

          if [ ! -f "$REPORT" ]; then
            echo "[VERIFY][FAIL] daily_brief.md not found"
            exit 1
          fi

          if grep -q "^Confidence:" "$REPORT"; then
            echo "[VERIFY][OK] Regime confidence emitted in report"
          else
            echo "[VERIFY][FAIL] Confidence line missing in REGIME SUMMARY"
            exit 1
          fi

          echo "[VERIFY][OK] Core dataset confidence verification passed"

      - name: Track Ops Freshness (Phase 36-B)
        run: |
          python -m src.ops.freshness_tracker

      - name: Update Ops Scoreboard (Phase 36-B)
        run: |
          python -m src.ops.ops_scoreboard

      - name: Run Topic Candidate Gate (Phase 39)
        run: |
          python -m src.topics.topic_candidate_gate

      - name: Integrate Final Decision Card (Phase 38)
        run: |
          python -m src.decision.final_decision_card

      - name: Generate Main Dashboard
        run: |
          python -m src.dashboard.topic_exporter
          python -m src.dashboard.dashboard_generator

      - name: Run IssueSignal Engine (IS-49 Loop Lock)
        run: |
          python -m src.issuesignal.run_issuesignal --mode=production


      - name: Generate Ops Metadata
        run: |
          python -m src.ops.dashboard_manifest
          python -m src.ops.health_check
          python -m src.ops.event_coverage

      - name: Prepare Docs for Deployment
        run: |
          # [IS-56] Clean docs/data to remove stale/mock artifacts
          rm -rf docs/data
          mkdir -p docs/data
          mkdir -p docs/issuesignal
          cp dashboard/index.html docs/index.html
          cp -r data/dashboard/* docs/data/ || true
          cp -r data/dashboard/issuesignal/* docs/issuesignal/ || true
          cp -r data/reports docs/data/ || true
          
          # [IS-51] Operational Dashboard Guarantee
          # Flatten the latest operational dashboard to root docs for easy access
          find data/reports -name "operational_dashboard.md" -exec cp {} docs/operational_dashboard.md \;

      - name: Upload Pages Artifact (IS-49 Guarantee)
        uses: actions/upload-artifact@v4
        with:
          name: pages-artifact
          path: docs/

      - name: Verify Phase 39 Topic Candidates
        run: |
          echo "[VERIFY] Phase 39 Topic Candidate Gate Check"
          YMD=$(TZ='Asia/Seoul' date +"%Y/%m/%d")
          CAND="data/topics/candidates/$YMD/topic_candidates.json"
          DASH="dashboard/index.html"
          
          if [ -f "$CAND" ]; then
             echo "[VERIFY][OK] topic_candidates.json generated"
             # Check internal structure
             if grep -q "alive_count" "$CAND"; then
                echo "[VERIFY][OK] Candidate metadata present"
             fi
          else
             echo "[VERIFY][FAIL] topic_candidates.json missing"
             exit 1
          fi
          
          if grep -q "üìÇ ÌÜ†ÌîΩ ÌõÑÎ≥¥Íµ∞" "$DASH"; then
             echo "[VERIFY][OK] Dashboard section rendered"
          else
             echo "[VERIFY][FAIL] Dashboard section missing"
             exit 1
          fi

      - name: Verify Phase 36-B Ops Hardening
        run: |
          echo "[VERIFY] Phase 36-B Ops Hardening Check"
          YMD=$(TZ='Asia/Seoul' date +"%Y/%m/%d")
          FRESH="data/ops/freshness/$YMD/freshness_summary.json"
          SCORE="data/ops/scoreboard/$YMD/ops_scoreboard.json"
          DASH="dashboard/index.html"
          
          if [ -f "$FRESH" ]; then
            echo "[VERIFY][OK] freshness_summary.json generated"
            grep -q "tracker_version" "$FRESH" && echo "[VERIFY][OK] tracker_version present" || (echo "[VERIFY][FAIL] tracker_version missing"; exit 1)
          else
            echo "[VERIFY][SKIP] No freshness data (valid state)"
          fi
          
          if [ -f "$SCORE" ]; then
            echo "[VERIFY][OK] ops_scoreboard.json generated"
            grep -q "scoreboard_version" "$SCORE" && echo "[VERIFY][OK] scoreboard_version present" || (echo "[VERIFY][FAIL] scoreboard_version missing"; exit 1)
          else
            echo "[VERIFY][SKIP] No scoreboard data (valid state)"
          fi
          
          grep -q "Ïö¥ÏòÅ ÏÑ±Í≥º ÏßÄÌëú" "$DASH" && echo "[VERIFY][OK] Ops section rendered" || (echo "[VERIFY][FAIL] Ops section missing"; exit 1)

      - name: Verify Phase 38 Final Decision Card
        run: |
          echo "[VERIFY] Phase 38 Final Decision Card Check"
          YMD=$(TZ='Asia/Seoul' date +"%Y/%m/%d")
          CARD="data/decision/$YMD/final_decision_card.json"
          DASH="dashboard/index.html"
          
          if [ -f "$CARD" ]; then
            echo "[VERIFY][OK] final_decision_card.json generated"
            grep -q "phase66_editorial_v1" "$CARD" && echo "[VERIFY][OK] card_version present" || (echo "[VERIFY][FAIL] card_version missing"; exit 1)
          else
            echo "[VERIFY][OK] No final decision card today (valid state)"
          fi
          
          grep -q "Ïò§ÎäòÏùò ÏΩòÌÖêÏ∏† ÌõÑÎ≥¥" "$DASH" && echo "[VERIFY][OK] Final Decision section rendered" || (echo "[VERIFY][FAIL] Final Decision section missing"; exit 1)

      - name: Commit Intelligence Outputs
        if: success()
        run: |
          git config user.name "hoin-bot"
          git config user.email "hoin-bot@users.noreply.github.com"
          # Force add all production directories and root index
          git add . || true
          
          # Check for changes
          if git diff --cached --quiet; then
            echo "No intelligence changes to commit"
          else
            git commit -m "chore: save intelligence artifacts and docs"
            git fetch origin main
            git rebase origin/main
            git push origin main
          fi

      - name: Create issue on failure
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          y=$(TZ='Asia/Seoul' date +"%Y-%m-%d")
          gh issue create --title "Pipeline failed: ${y}" --body "full_pipeline failed. Check Actions logs and committed artifacts (if any)."
