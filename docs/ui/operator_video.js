/**
 * operator_video.js â€” VIDEO CANDIDATE POOL ADAPTER
 * Premium Tailwind-based Rendering for Phase 18
 */

export async function initVideoView(container) {
    container.innerHTML = `
        <div class="p-8 flex flex-col items-center justify-center space-y-4">
            <div class="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <div class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Loading Video Intelligence...</div>
        </div>
    `;

    try {
        const paths = [
            './data/ops/video_candidate_pool.json',
            '../data/ops/video_candidate_pool.json'
        ];

        let data = null;
        for (const path of paths) {
            try {
                const res = await fetch(path);
                if (res.ok) {
                    data = await res.json();
                    break;
                }
            } catch (e) { }
        }

        if (!data || !data.top_candidates || data.top_candidates.length === 0) {
            renderEmptyVideoState(container);
            return;
        }

        renderVideoCandidates(container, data.top_candidates);
    } catch (err) {
        console.error('[VideoView] Error:', err);
        container.innerHTML = `
            <div class="p-8 text-red-500 font-mono text-xs bg-red-500/5 rounded border border-red-500/20 m-4">
                [VIDEO_ERROR] Load Failed: ${err.message}
            </div>
        `;
    }
}

function renderEmptyVideoState(container) {
    container.innerHTML = `
        <div class="max-w-4xl mx-auto py-20 px-4 text-center">
            <div class="text-6xl mb-6 opacity-20">ğŸ¬</div>
            <h3 class="text-xl font-black text-slate-400 mb-2 uppercase tracking-tighter">í˜„ì¬ ì„ ë³„ëœ ì˜ìƒ í›„ë³´ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-sm text-slate-500 max-w-md mx-auto leading-relaxed">
                NS ì ìˆ˜ ë° êµ¬ì¡°ì  ì¡°ê±´(Axis, Trigger)ì„ ì¶©ì¡±í•˜ëŠ” ì§€ëŠ¥í˜• ì„ ë³„ í† í”½ì´ ë°œê²¬ë˜ë©´ ì´ê³³ì— ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
            </p>
        </div>
    `;
}

function renderVideoCandidates(container, candidates) {
    // Sort by video_score desc
    candidates.sort((a, b) => (b.video_score || 0) - (a.video_score || 0));
    const top3 = candidates.slice(0, 3);

    container.innerHTML = `
        <div class="space-y-8 fade-in">
            <header class="mb-10 px-4">
                <div class="text-[10px] font-black text-blue-500 uppercase tracking-[0.4em] mb-2">Video Intelligence Layer</div>
                <h1 class="text-4xl font-black text-white tracking-tighter uppercase leading-none">í¸ì§‘ íšŒì˜ ë³´ë“œ</h1>
                <p class="text-slate-500 text-sm mt-4 font-medium max-w-2xl">
                    ì˜ìƒ ì œì‘ íŒŒê¸‰ë ¥(Video Score)ì´ ë†’ì€ ìƒìœ„ 3ê°œ í† í”½ì„ ì„ ë³„í–ˆìŠµë‹ˆë‹¤. 
                    ì„œì‚¬ ì ìˆ˜(NS)ì™€ í•¨ê»˜ ì˜ìƒí™” ì‹œ íŒŒê¸‰ë ¥ì„ ê²€í† í•˜ì‹­ì‹œì˜¤.
                </p>
            </header>

            <div class="grid gap-6 px-4">
                ${top3.map((c, idx) => renderVideoCard(c, idx)).join('')}
            </div>
            
            <footer class="mt-20 py-10 border-t border-slate-800 text-center opacity-30 px-4">
                <div class="text-[10px] font-black text-slate-500 uppercase tracking-widest">
                    Generated by HOIN Video Intelligence Engine v1.0
                </div>
            </footer>
        </div>
    `;
}

function renderVideoCard(c, idx) {
    const isTop = idx === 0;
    const borderClass = isTop ? 'border-amber-500/50' : 'border-slate-800';
    const bgClass = isTop ? 'bg-amber-500/5' : 'bg-slate-900/50';

    const ns = c.narrative_score != null ? c.narrative_score : 'N/A';
    const vs = c.video_score != null ? c.video_score : 'N/A';
    const intensity = c.intensity != null ? `${c.intensity}%` : 'N/A';
    const conflict = c.conflict_flag ? '<span class="text-red-500 animate-pulse">âš ï¸ CONFLICT</span>' : '';

    return `
        <div class="${bgClass} border ${borderClass} rounded-2xl p-8 relative overflow-hidden group transition-all duration-300 hover:border-blue-500/50">
            ${isTop ? '<div class="absolute top-0 left-0 w-1.5 h-full bg-amber-500"></div>' : ''}
            
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <div class="flex items-center gap-3">
                    <span class="bg-slate-800 text-white text-[10px] font-black px-3 py-1 rounded-full border border-slate-700 tracking-widest">
                        RANK ${idx + 1}
                    </span>
                    <span class="text-[10px] font-black text-slate-500 uppercase">${c.dataset_id || 'unknown'}</span>
                </div>
                <div class="font-black text-[10px] tracking-widest uppercase">
                    ${conflict}
                </div>
            </div>

            <h2 class="text-2xl font-black text-white mb-6 group-hover:text-blue-400 transition-colors tracking-tight leading-tight">${c.title || 'Untitled Topic'}</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div class="bg-black/40 border border-slate-800 rounded-xl p-4 flex justify-between items-center">
                    <div>
                        <div class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Video Score</div>
                        <div class="text-3xl font-black text-amber-500">${vs}</div>
                    </div>
                    <div class="text-amber-500/20 text-4xl">ğŸ¬</div>
                </div>
                <div class="bg-black/40 border border-slate-800 rounded-xl p-4 flex justify-between items-center">
                    <div>
                        <div class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Narrative Score</div>
                        <div class="text-3xl font-black text-blue-500">${ns}</div>
                    </div>
                    <div class="text-blue-500/20 text-4xl">ğŸ¹</div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 gap-8 text-[11px] border-t border-slate-800/50 pt-6">
                <div class="space-y-1">
                    <div class="text-slate-500 font-bold uppercase tracking-wider">INTENSITY</div>
                    <div class="text-white font-black">${intensity}</div>
                </div>
                <div class="space-y-1">
                    <div class="text-slate-500 font-bold uppercase tracking-wider">TRIGGER</div>
                    <div class="text-white font-black">${c.why_now_type || 'N/A'}</div>
                </div>
                <div class="space-y-1 col-span-2 md:col-span-1">
                    <div class="text-slate-500 font-bold uppercase tracking-wider">DETECTED AXES</div>
                    <div class="text-white font-black break-words">${(c.structural_axes || []).join(', ') || 'N/A'}</div>
                </div>
            </div>
        </div>
    `;
}
