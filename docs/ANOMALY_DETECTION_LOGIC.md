# 🧠 ANOMALY_DETECTION_LOGIC

> 기준: **DATA_COLLECTION_MASTER**(중복 제거 + 파생 유지 최종본)  
> 목표: **가격 예측이 아니라 “왜 지금 이 주제가 선택되어야 하는가”를 선행 데이터와 이상징후로 포착**

---

## 0) 운영 원칙 (고정)

- **원천 데이터는 최소**로 수집하고, **파생은 로직으로 생성**한다.
- 이상징후는 “맞히기”가 아니라 **주제 선점(선제 설명)**을 위해 기록한다.
- **단일 지표 급변**보다 **교차(멀티-센서) 동시 신호**를 우선한다.
- 모든 이상징후는 **발생 시각, 원인 후보, 연쇄 가능성(2차 파급)**을 함께 남긴다.
- 무료/부분/후보(CANDIDATE) 데이터는 **신뢰 레벨**을 낮춰 가중치를 조정한다.

---

## 1) 입력 데이터 (DATA_COLLECTION_MASTER 기반)

### 1-1. 원천 수집 데이터
- 금리/거시: Fed Funds, 한국 기준금리, 2Y/10Y, M1/M2, CPI/CoreCPI, PPI, PCE, GDP, 실업률, NFP, BEI
- FX: USD/KRW, EUR/USD, USD/JPY, DXY
- Equity: S&P500, NASDAQ, KOSPI, KOSDAQ, 거래대금, VIX
- Credit: IG 스프레드, HY 스프레드, 금융 스트레스 지수
- Commodities: 금, 은, WTI, Brent, 천연가스, 구리, (후보)천연고무
- Crypto: BTC, ETH, 거래량, (후보)전체 시가총액, (후보)BTC 도미넌스
- Real Estate(확장 ㉜): 주택가격지수, 거래량, 전세가율, 미분양

### 1-2. 파생 데이터(로직)
- 금리 스프레드(10Y–2Y)
- 위험선호 지수(Equity + VIX + FX)
- 자산 대체 이동 지표(Commodities/Equity/Crypto 교차)

---

## 2) 공통 전처리 / 표준화

### 2-1. 시간단위 정규화
- **1분 데이터**(지수/코인 등): 1시간 봉, 1일 봉을 함께 생성
- **1일 데이터**: D-1 대비 변화율 및 5/20/60일 기준선 산출
- **월/분기 데이터**: 발표일 기준으로 “발표 이벤트”로 처리

### 2-2. 이상징후 판단용 기본 피처 (모든 시계열 공통)
- 변화율(Δ): `pct_change(1)`
- 가속도(ΔΔ): 변화율의 변화
- 변동성: 20기간 표준편차(또는 ATR 개념)
- Z-Score: `((값-rolling_mean)/rolling_std)`
- 퍼센타일: 최근 1년 분포 내 위치

### 2-3. 베이스라인(기준선) 윈도우
- 초단기: 1일~5일
- 단기: 20일
- 중기: 60일
- 장기: 252일(거래일 1년)

---

## 3) 이상징후 레벨 정의 (Severity)

- **L1 (관찰)**: 단일 지표의 비정상(약)
- **L2 (주의)**: 단일 지표 강한 비정상 또는 2개 축 동시
- **L3 (경보)**: 3개 이상 축 동시 + 방향 일치
- **L4 (주제 확정 후보)**: 교차 신호가 “내러티브”로 연결되고, 이벤트(정책/발표/리스크) 타이밍이 겹침

기본 룰(권장):
- L1: |Z| ≥ 1.5 또는 1년 퍼센타일 90%/10% 돌파
- L2: |Z| ≥ 2.0 또는 1년 퍼센타일 95%/5% 돌파
- L3: 3개 축 이상 L2 동시(±2일 내)
- L4: L3 + (정책/발표/이벤트 캘린더와 겹침) 또는 (자산 대체 이동 지표가 뚜렷)

---

## 4) 축별 이상징후 룰 (단일 센서)

### 4-1. 금리/유동성/거시

**(A) 금리 쇼크**
- 조건: 2Y 또는 10Y의 1일 변화가 최근 1년 상위 95% (또는 |Z|≥2)
- 의미: 정책 기대 급변 → 성장/기술주/원자재/달러로 파급

**(B) 커브 급변 (스프레드)**
- 조건: (10Y–2Y) 스프레드가 5일 내 급격한 확대/축소, |Z|≥2
- 의미: 경기 전환(침체/회복) 논의 점화

**(C) 인플레 레짐 전환**
- 조건: CPI/CoreCPI/PCE 중 2개 이상이 3개월 연속 가속(ΔΔ>0) 또는 Z≥2
- 의미: 금리·달러·원자재·주식 섹터 로테이션 주제

**(D) 실물 고용 균열**
- 조건: 실업률 상승 추세(3개월 연속) + NFP 급감(퍼센타일 하위 10%)
- 의미: 경기 둔화/방어주/채권 선호 주제

**(E) 유동성 방향 전환(M1/M2)**
- 조건: M2 증가율이 급격히 둔화/반등(장기 대비 |Z|≥2)
- 의미: 위험자산 유입/이탈 가능성

### 4-2. FX

**(F) 달러 레짐 변화(DXY)**
- 조건: DXY가 20일 평균 대비 ±2σ 이탈 + 추세 지속(3일)
- 의미: 신흥국/원자재/글로벌 주식 방향성 주제

**(G) 원화 스트레스(USD/KRW)**
- 조건: USD/KRW 급등(상위 95%) + KOSPI 약세 동반
- 의미: 국내 리스크, 외국인 수급, 환헤지/원자재 비용 주제

**(H) 엔화 위험회피(USD/JPY)**
- 조건: USD/JPY 급변 + VIX 동반 상승
- 의미: 리스크 오프 국면 점화

### 4-3. Equity

**(I) 지수 급락/급등**
- 조건: S&P500/NASDAQ/KOSPI/KOSDAQ 중 1개라도 1일 변동이 상위 95%
- 의미: 단기 주제(정책/실적/지정학) 트리거

**(J) 거래대금 이례(참여 변화)**
- 조건: 거래대금이 20일 평균 대비 2배 이상 + 지수 방향성 동반
- 의미: “진짜 돈이 들어온/나간” 테마 가능

**(K) 변동성 레짐(VIX)**
- 조건: VIX가 20일 평균 대비 +2σ (또는 급등) / 급락(침묵 구간)
- 의미: 공포 급증(방어/현금) 또는 과도한 안도(급변 전조)

### 4-4. Credit

**(L) 신용 스프레드 확대(IG/HY)**
- 조건: IG 또는 HY 스프레드가 5일 내 급확대 + |Z|≥2
- 의미: 위험회피(디폴트/금융 불안) 주제

**(M) 금융 스트레스 지수 급등**
- 조건: 금융 스트레스 지수 상위 95% 진입
- 의미: 시스템 리스크/정책 개입 기대/은행주 변동성

### 4-5. Commodities

**(N) 금 급등(안전자산 쏠림)**
- 조건: 금이 강세 + DXY 강세 또는 VIX 상승과 동시
- 의미: 위험회피/지정학/통화신뢰 하락 주제

**(O) 은의 분기점(산업+투기)**
- 조건: 은이 금 대비 강세(금/은 관계에서 은 상대강도 상승) + 구리 동반
- 의미: 경기 기대/산업 회복 서사

**(P) 유가 쇼크(WTI/Brent)**
- 조건: WTI 또는 Brent 급등/급락(상위 95%)
- 의미: 인플레 재점화, 지정학, 에너지 섹터 주제

**(Q) 가스/구리 괴리**
- 조건: 천연가스 급등 + 구리 약세(또는 반대)로 방향 괴리 심화
- 의미: 공급 충격 vs 수요 둔화 논쟁

**(R) 천연고무(후보) 점화**
- 조건: (후보) 천연고무 가격 급등 + EV/타이어 관련 뉴스 빈도 증가
- 의미: 공급 비탄력 기반 산업 테마

### 4-6. Crypto

**(S) BTC 레짐 전환**
- 조건: BTC 1일 변동 상위 95% 또는 3일 연속 상승/하락 가속
- 의미: 위험선호 선행/주말 반응/유동성 기대 변화

**(T) 거래량 과열/위축**
- 조건: 거래량이 20일 평균 대비 2배 이상(과열) 또는 50% 이하(침묵)
- 의미: 투기/관심 급증 또는 변곡 준비

**(U) 도미넌스/총시총(후보)**
- 조건: BTC 도미넌스 급등(리스크 회피) 또는 급락(알트 투기)
- 의미: 시장 심리 분기점

### 4-7. Real Estate(확장 ㉜)

**(V) 거래량 급감 + 미분양 증가**
- 조건: 거래량 급감(전년동월 대비) + 미분양 상승
- 의미: 부동산 경기 침체 서사 강화

**(W) 전세가율 급등**
- 조건: 전세가율 상승 + 금리 상승 동시
- 의미: 가계 레버리지 스트레스(소비 둔화) 주제

---

## 5) 교차(멀티-센서) 이상징후 룰 (주제 생성 핵심)

### 5-1. 리스크 오프(위험회피) 클러스터
- 트리거: (VIX ↑) + (HY 스프레드 ↑ 또는 금융 스트레스 ↑) + (USD/JPY 변동 또는 DXY ↑) 중 2개 이상
- 결과: **방어주/현금/금/달러** 주제 후보

### 5-2. 인플레 재점화 클러스터
- 트리거: (WTI/Brent ↑) + (BEI ↑ 또는 CPI/PCE 가속) + (2Y/10Y ↑)
- 결과: **금리 재상승, 성장주 부담, 원자재/에너지** 주제 후보

### 5-3. 경기 침체/연착륙 분기 클러스터
- 트리거: (스프레드 변화) + (실업률/고용 악화) + (주가지수 추세 약화)
- 결과: **침체/연착륙/방어 섹터 로테이션** 주제 후보

### 5-4. 달러 레짐 전환(신흥국/원자재/한국 영향)
- 트리거: DXY 급변 + USD/KRW 동반 + 원자재(구리/유가) 반응
- 결과: **환율/수출/원자재 비용/외국인 수급** 주제 후보

### 5-5. ‘투기 심리 선행’(코인→주식)
- 트리거: BTC 급등/급락 + 거래량 과열 + NASDAQ 동조(±2일)
- 결과: **위험선호 회복/붕괴** 주제 후보

### 5-6. 실물-금융 괴리(왜곡 감지)
- 트리거: 구리 약세(실물 둔화) + 주식 강세(낙관) 또는 반대
- 결과: **내러티브 충돌(거짓 랠리/과도 비관)** 주제 후보

---

## 6) 주제 후보 생성 규칙 (Topic Candidate Engine)

### 6-1. 후보 생성 조건
- L2 이상 신호가 **24~72시간 내 2개 축 이상** 발생
- 또는 L3 이상 클러스터 트리거 발생

### 6-2. 후보 라벨(예시)
- Risk-Off, Inflation Re-accel, Dollar Regime Shift, Credit Stress, Energy Shock, Growth Rotation, Korea FX Stress, Crypto-led Risk-On

### 6-3. 후보 출력 포맷(고정)
- **주제명(라벨)**
- **발생 시각(UTC/KST)**
- **촉발 센서 TOP3**
- **확증 센서 TOP3**
- **반증 센서 TOP2**
- **다음 확인 이벤트(캘린더)**

---

## 7) 로그 스키마 (필수)

### 7-1. ANOMALY_LOG 항목
- id
- detected_at (KST)
- severity (L1~L4)
- cluster (없으면 null)
- primary_sensors (최대 3)
- secondary_sensors (최대 3)
- direction (risk-on/off, inflation-up/down 등)
- evidence (수치/퍼센타일/Z)
- narrative_hypothesis (한 줄)
- next_check (이벤트/지표)
- status (OPEN / WATCH / CONFIRMED / CLOSED)

### 7-2. 종료 규칙
- 3영업일 내 추가 확증 없음 → WATCH
- 반증 센서가 2개 이상 충족 → CLOSED
- 이벤트 이후 방향성 확정 → CONFIRMED

---

## 8) 최소 운영 세트(추천)

> 초기 자동화에서는 아래 센서만으로도 주제 선점의 80%를 커버

- 금리: 2Y, 10Y, 스프레드
- 물가: CPI/CoreCPI/PCE, BEI
- FX: DXY, USD/KRW, USD/JPY
- Equity: S&P500/NASDAQ, 거래대금, VIX
- Credit: HY 스프레드, 금융 스트레스
- Commodities: WTI/Brent, 금, 구리
- Crypto: BTC, 거래량
- (국내 확장) 부동산 거래량/미분양

---

## 9) 다음 단계(누적 규칙)

- 새로운 데이터 축 추가 시: **DATA_COLLECTION_MASTER → ANOMALY_DETECTION_LOGIC** 순서로 규칙을 덧붙인다.
- 로직 변경은 “교체”가 아니라 **추가(누적)**로만 기록한다.

---

📌 이 문서는 **Hoin Engine의 이상징후 탐지 로직 공식 기준**이며,  
📌 목표는 **주제 선정의 눈(선점)을 데이터로 강화**하는 것이다.
